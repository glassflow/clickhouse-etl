# Auth0 Env Toggle and Build vs Runtime Behavior

## TL;DR

- Use `AUTH0_ENABLED` (server-only) as the source of truth to enable/disable Auth0.
- `NEXT_PUBLIC_AUTH0_ENABLED` is inlined by Next.js at build time; do not rely on it for runtime toggling.
- Changing `AUTH0_ENABLED` requires a server process restart to take effect.
- Client code should read `window.__ENV__.NEXT_PUBLIC_AUTH0_ENABLED` (from `public/env.js`) only for UI hints, not for enforcement.

## Where Auth0 is wired

- `src/lib/auth0.ts`: creates Auth0Client (server) with routes.
- `src/app/api/auth/[auth0]/route.ts`: delegates to `auth0.middleware`.
- `src/utils/auth-config.server.ts`: `isAuthEnabled()` checks env to decide if auth is on.
- `src/middleware.ts`: bypasses `/ui-api/*`; otherwise allows routes and relies on auth checks in pages/api.

## Env Resolution (isAuthEnabled)

1. `AUTH0_ENABLED` (server env) – primary. Read at runtime; not inlined by Next.js.
2. Fallback: `NEXT_PUBLIC_AUTH0_ENABLED` – only if server var missing; note this is inlined at build.
   - `startup.sh` (if used) syncs public flag to match server flag.

## Build-time vs Runtime

- **Build-time**: Next.js inlines `process.env.NEXT_PUBLIC_*` into client/server bundles. Values present at `next build` are baked in.
- **Runtime (server)**: `process.env.AUTH0_ENABLED` is read at request time; can change with a process restart (no rebuild required).
- **Runtime (client)**: `public/env.js` (generated by `generate-env.mjs`) exposes `NEXT_PUBLIC_*` via `window.__ENV__`. Update by regenerating `env.js` (restart dev/server or run the script).

## How to toggle Auth0

- Enable: set `AUTH0_ENABLED=true` (and the required `AUTH0_*` secrets), restart server.
- Disable: set `AUTH0_ENABLED=false`, restart server. UI may also set `NEXT_PUBLIC_AUTH0_ENABLED=false` for consistency, but enforcement is server-side.
- Do **not** expect `NEXT_PUBLIC_AUTH0_ENABLED` to change behavior at runtime without rebuild unless you also regenerate `public/env.js` and restart server for server reads.

## Why runtime override can fail

- The Auth0 SDK and Next.js may inline `NEXT_PUBLIC_AUTH0_ENABLED` during build. If you only change the public var at runtime (without rebuild/regenerating `env.js`), client bundles will still see the old value.
- Server checks use `AUTH0_ENABLED` and are evaluated at runtime, but the Node process must restart to pick up new env.

## Recommended pattern

- Treat `AUTH0_ENABLED` as the single flag for enabling/disabling auth.
- Keep `NEXT_PUBLIC_AUTH0_ENABLED` as a UI hint; synchronize it via `generate-env.mjs` (and rebuild only if you need the client bundle to change baked values).
- After changing auth flags, restart the server (and regenerate `public/env.js`).

## Related files

- `src/utils/auth-config.server.ts` (env resolution)
- `src/lib/auth0.ts`
- `src/app/api/auth/[auth0]/route.ts`
- `src/middleware.ts`
- `generate-env.mjs` and `public/env.js`
- `.cursor/architecture/ENVIRONMENT.md`
