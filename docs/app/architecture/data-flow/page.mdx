---
title: 'Data Flow'
description: 'Understanding how data flows through GlassFlow pipelines'
---

# Data Flow

This document explains how data flows through a GlassFlow pipeline and how the acknowledgment mechanism ensures reliable data processing from Kafka to ClickHouse.

## Overview

GlassFlow processes data through multiple stages, each with its own acknowledgment mechanism to ensure data reliability and prevent data loss. The pipeline uses a two-phase acknowledgment system:

1. **Kafka Consumer Acknowledgment**: Commits offsets only after successful processing
2. **NATS JetStream Acknowledgment**: Acknowledges messages after successful writes to downstream components

## Data Flow Architecture

A typical GlassFlow pipeline follows this flow:

![Data Flow Architecture](/assets/architecture_data_flow.png)

### Stage 1: Kafka to NATS JetStream (Ingestor)

The **Ingestor** component consumes messages from Kafka topics and publishes them to NATS JetStream streams.

**Process:**

1. Kafka consumer polls for messages in batches
2. Each message is transformed and published to a NATS JetStream stream
3. Kafka offsets are committed only after all messages in the batch are successfully published to NATS

**Acknowledgment:**

- Kafka uses **manual offset commits** (auto-commit is disabled)
- Offsets are committed only after the entire batch is successfully published to NATS JetStream
- If publishing fails, the batch is not committed, and Kafka will redeliver the messages

**Failure Handling:**

- If a message cannot be published to NATS, it is sent to the Dead Letter Queue (DLQ)
- The Kafka offset is still committed for that message to prevent reprocessing
- Failed messages can be retrieved from the DLQ for manual inspection or reprocessing

### Stage 2: NATS JetStream Processing

NATS JetStream acts as an internal message broker between pipeline components. It provides persistent storage and reliable message delivery.

**Consumer Configuration:**

- All NATS JetStream consumers use the **AckAll** acknowledgment policy
- This means acknowledging the last message in a batch automatically acknowledges all previous messages in that batch
- Consumers have an `AckWait` timeout (default: 30 seconds) - if a message is not acknowledged within this time, NATS will redeliver it

**Acknowledgment Policy:**

- **AckAll Policy**: When the last message in a batch is acknowledged, all previous messages in the batch are automatically acknowledged
- This provides efficient batch processing while maintaining reliability

### Stage 3: Deduplication (Optional)

If deduplication is enabled, the **Deduplication Service** processes messages before they reach the sink.

**Process:**

1. Messages are read from the ingestor output stream
2. Duplicate detection is performed using a key-value store (BadgerDB)
3. Only unique messages are forwarded to the sink
4. Messages are acknowledged only after successful deduplication and forwarding

**Acknowledgment:**

- Messages are acknowledged only after:
  1. Successful deduplication check
  2. Successful write to the downstream stream (sink or join)
- If deduplication fails, messages are **NAKed** (negatively acknowledged), causing NATS to redeliver them
- The acknowledgment uses the AckAll policy - acknowledging the last message in a batch acknowledges all messages in that batch

**Failure Handling:**
- If deduplication or forwarding fails, all messages in the batch are NAKed
- NATS JetStream will redeliver the messages after the `AckWait` timeout expires
- This ensures no data loss during deduplication failures

### Stage 4: Join (Optional)

If join is enabled, the **Join Service** combines messages from multiple streams based on join keys and time windows.

**Process:**

1. Messages are consumed from multiple source streams
2. Join logic matches messages based on join keys within a time window
3. Joined messages are published to a joined output stream
4. Messages are acknowledged after successful join and publication

**Acknowledgment:**

- Similar to deduplication, messages are acknowledged only after successful join processing
- Uses AckAll policy for batch acknowledgment
- Failed joins result in NAK, causing message redelivery

### Stage 5: ClickHouse Sink

The **Sink** component consumes messages from NATS JetStream and writes them to ClickHouse in batches.

**Process:**

1. Messages are consumed from the NATS stream (either from ingestor, deduplication, or join output)
2. Messages are batched according to `max_batch_size` and `max_delay_time` configuration
3. Batches are written to ClickHouse using bulk insert operations
4. Messages are acknowledged only after successful write to ClickHouse

**Acknowledgment:**

- After a successful batch write to ClickHouse, the **last message in the batch** is acknowledged
- Due to the AckAll policy, this acknowledges all messages in the batch
- Acknowledgment is retried up to 3 times if it fails initially

**Failure Handling:**

- If a batch write to ClickHouse fails:
  1. All messages in the failed batch are sent to the DLQ
  2. Each message is individually acknowledged after being written to the DLQ
  3. This prevents message loss while allowing investigation of the failure
- Messages in the DLQ can be retrieved and reprocessed later
