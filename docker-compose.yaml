services:
  nats:
    image: nats:alpine
    ports:
      - 4222:4222
    command: --js
    restart: unless-stopped

  ui:
    image: ghcr.io/glassflow/glassflow-etl-fe:main
    pull_policy: always
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://api:8081}
      - NEXT_PUBLIC_IN_DOCKER=${NEXT_PUBLIC_IN_DOCKER:-true}
      - NEXT_PUBLIC_PREVIEW_MODE=${NEXT_PUBLIC_PREVIEW_MODE:-false}
      - NEXT_PUBLIC_USE_MOCK_API=${NEXT_PUBLIC_USE_MOCK_API:-false}
      - NEXT_PUBLIC_ANALYTICS_ENABLED=${NEXT_PUBLIC_ANALYTICS_ENABLED:-true}
      - NEXT_PUBLIC_DEMO_MODE=${NEXT_PUBLIC_DEMO_MODE:-false}
      # Sidecar service url - used for Kafka Kerberos connections
      - KAFKA_GATEWAY_URL=${KAFKA_GATEWAY_URL:-http://kafka-gateway:8082}
      # Auth0 Configuration (Optional - set NEXT_PUBLIC_AUTH0_ENABLED=true to enable)
      - NEXT_PUBLIC_AUTH0_ENABLED=${NEXT_PUBLIC_AUTH0_ENABLED:-false}
      - AUTH0_SECRET=${AUTH0_SECRET}
      - APP_BASE_URL=${APP_BASE_URL:-http://localhost:8080}
      - AUTH0_DOMAIN=${AUTH0_DOMAIN}
      - AUTH0_ISSUER_BASE_URL=${AUTH0_ISSUER_BASE_URL:-https://${AUTH0_DOMAIN}}
      - AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}
      - AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}
      # OpenTelemetry Configuration
      - NEXT_PUBLIC_OTEL_LOGS_ENABLED=${NEXT_PUBLIC_OTEL_LOGS_ENABLED:-true}
      - NEXT_PUBLIC_OTEL_METRICS_ENABLED=${NEXT_PUBLIC_OTEL_METRICS_ENABLED:-true}
      - NEXT_PUBLIC_OTEL_SERVICE_NAME=${NEXT_PUBLIC_OTEL_SERVICE_NAME:-glassflow-ui}
      - NEXT_PUBLIC_OTEL_SERVICE_VERSION=${NEXT_PUBLIC_OTEL_SERVICE_VERSION:-dev}
      - NEXT_PUBLIC_OTEL_SERVICE_NAMESPACE=${NEXT_PUBLIC_OTEL_SERVICE_NAMESPACE:-local}
      - NEXT_PUBLIC_OTEL_SERVICE_INSTANCE_ID=${NEXT_PUBLIC_OTEL_SERVICE_INSTANCE_ID:-}
      - NEXT_PUBLIC_OTEL_EXPORTER_OTLP_ENDPOINT=${NEXT_PUBLIC_OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4318}
      - NEXT_PUBLIC_LOG_LEVEL=${NEXT_PUBLIC_LOG_LEVEL:-info}
    depends_on:
      - kafka-gateway

  kafka-gateway:
    image: ghcr.io/glassflow/kafka-kerberos-gateway:latest
    ports:
      - "8082:8082"
    environment:
      - PORT=8082
      - LOG_LEVEL=${GATEWAY_LOG_LEVEL:-info}
    restart: unless-stopped
    # Optional: Expose port for direct testing
    # ports:
    #   - "8082:8082"

  api:
    image: ghcr.io/glassflow/glassflow-etl-be:stable
    pull_policy: always
    depends_on:
      - nats
    restart: unless-stopped
    environment:
      GLASSFLOW_LOG_FILE_PATH: /tmp/logs/glassflow
      GLASSFLOW_NATS_SERVER: nats:4222
      GLASSFLOW_RUN_LOCAL: true
      GLASSFLOW_K8S_NAMESPACE: glassflow
      GLASSFLOW_SERVER_ADDR: 0.0.0.0:8081
      GLASSFLOW_OTEL_METRICS_ENABLED: false
      GLASSFLOW_OTEL_LOGS_ENABLED: false
      GLASSFLOW_NATS_MAX_STREAM_AGE: 12h
      GLASSFLOW_NATS_MAX_STREAM_BYTES: 536870912
    volumes:
      - logs:/tmp/logs/glassflow

  nginx:
    image: nginx:1.27-alpine
    ports:
      - 8080:8080
      - 8081:8081
    depends_on:
      - ui
      - api
    volumes:
      - logs:/logs:ro
      - ./nginx:/etc/nginx/templates
    restart: unless-stopped
    environment:
      NGINX_ENTRYPOINT_LOCAL_RESOLVERS: true

volumes:
  logs:
